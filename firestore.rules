
/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model for writes,
 * but allows for public readability of shared content like communities and profiles.
 * This supports discoverability while maintaining security.
 *
 * Data Structure:
 * - `/users/{userId}`: Strictly private user account data.
 * - `/community-profiles/{userId}`: Publicly readable profiles, writable only by the owner.
 * - `/communities/{communityId}`: Publicly readable communities, writable only by the owner.
 *   - `/communities/{communityId}/messages/{messageId}`: Messages are readable/writable by any signed-in user.
 * - `/stories/{storyId}`: Publicly readable, admin-only writes.
 *
 * Key Security Decisions:
 * - User data (`/users`) is strictly private.
 * - Community Profiles (`/community-profiles`) are public to read, but a user can only write to their own profile.
 * - Communities (`/communities`) are public to read, which is essential for discovery and search.
 *   Writes are restricted to the owner of the community, verified by the `ownerId` field.
 * - Listing all users from the top-level `/users` collection is explicitly
 *   disallowed to protect user privacy.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //================================================================================
    // Helper Functions
    //================================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingDoc() {
      return resource != null;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    // --- User Validation Functions ---
    function hasValidUserData(userId) {
      return request.resource.data.id == userId;
    }

    function isImmutableUserId() {
      return request.resource.data.id == resource.data.id;
    }
    
    // --- Community Validation Functions ---
    function hasValidCommunityData() {
        return request.resource.data.ownerId == request.auth.uid;
    }
    
    function isImmutableCommunityOwnerId() {
        return request.resource.data.ownerId == resource.data.ownerId;
    }

    // --- Community Profile Validation ---
    function hasValidProfileData(userId) {
        return request.resource.data.userId == userId && request.resource.data.id == userId;
    }

    function isImmutableProfileIds() {
        return request.resource.data.id == resource.data.id && request.resource.data.userId == resource.data.userId;
    }

    // --- Story Validation Functions ---
    function hasValidStoryData() {
        return request.resource.data.userId == request.auth.uid;
    }

    //================================================================================
    // Collection Rules
    //================================================================================

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && hasValidUserData(userId);
      allow update: if isExistingOwner(userId) && isImmutableUserId();
      allow delete: if isExistingOwner(userId);
    }

     /**
     * @description Manages user community profiles.
     * @path /community-profiles/{userId}
     * @allow Anyone can read a profile, but only the owner can create/update/delete it.
     * @principle Public read access for profiles, but write access is restricted to the owner.
     */
    match /community-profiles/{userId} {
        allow get: if true;
        allow list: if true;
        allow create: if isOwner(userId) && hasValidProfileData(userId);
        allow update: if isOwner(userId) && isImmutableProfileIds();
        allow delete: if isOwner(userId);
    }

    /**
     * @description Manages all communities.
     * @path /communities/{communityId}
     * @allow Anyone can read/list communities for discovery. Only the owner can create, update, or delete.
     * @principle Balances public discoverability with strict ownership for writes.
     */
    match /communities/{communityId} {
        allow get: if true;
        allow list: if isSignedIn();
        allow create: if isSignedIn() && hasValidCommunityData();
        allow update: if isOwner(resource.data.ownerId) && isImmutableCommunityOwnerId();
        allow delete: if isOwner(resource.data.ownerId);

        /**
         * @description Manages voice messages within a community.
         * @path /communities/{communityId}/messages/{messageId}
         * @allow Any signed-in user can create a message. Any user can read messages.
         * @principle Encourages open communication within a community.
         */
        match /messages/{messageId} {
            allow read: if true;
            allow write: if isSignedIn();

             /**
             * @description Manages voice comments on a specific message.
             * @path /communities/{communityId}/messages/{messageId}/comments/{commentId}
             * @allow Any signed-in user can read or write comments.
             * @principle Fosters detailed discussion on individual messages.
             */
            match /comments/{commentId} {
                allow read: if true;
                allow write: if isSignedIn();
            }
        }
    }

    /**
     * @description Manages AI-generated stories for language learning.
     * @path /stories/{storyId}
     * @allow A user can read their own stories, and create new ones. List operation is allowed for signed-in users who query by their own user ID.
     * @deny A user cannot read, update, or delete other users' stories.
     * @principle Enforces user-specific ownership for all story data.
     */
    match /stories/{storyId} {
      allow get: if isOwner(resource.data.userId);
      allow list: if isSignedIn() && request.query.where[0][2] == request.auth.uid;
      allow create: if isSignedIn() && hasValidStoryData();
      allow update, delete: if isOwner(resource.data.userId);
    }
  }
}

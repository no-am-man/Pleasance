/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. All data
 * created by a user is stored within their own data tree and is inaccessible to
 * other users. This prevents data leakage and user enumeration.
 *
 * Data Structure: User-specific data, including their main profile and created
 * communities, is hierarchically organized under `/users/{userId}`. This
 * path-based ownership simplifies security rules significantly. Global, public
 * content like stories is stored in a separate top-level `/stories` collection.
 *
 * Key Security Decisions:
 * - User data is strictly private. A user can only access documents where the
 *   path contains their own UID.
 * - Listing all users from the top-level `/users` collection is explicitly
 *   disallowed to protect user privacy.
 * - The `/stories` collection is publicly readable by anyone but disallows writes.
 * - The `communities` subcollection is only accessible by the owner.
 *
 * Denormalization for Authorization: The rules rely on path-based ownership
 * (`/users/{userId}`), which is the most performant way to secure user data.
 * For documents within this structure (like Community), rules validate
 * that an `ownerId` field within the document matches the `userId` from the path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //================================================================================
    // Helper Functions
    //================================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingDoc() {
      return resource != null;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    // --- User Validation Functions ---
    function hasValidUserData(userId) {
      return request.resource.data.id == userId;
    }

    function isImmutableUserId() {
      return request.resource.data.id == resource.data.id;
    }
    
    // --- Community Validation Functions ---
    function hasValidCommunityData(userId) {
        return request.resource.data.ownerId == userId;
    }
    
    function isImmutableCommunityOwnerId() {
        return request.resource.data.ownerId == resource.data.ownerId;
    }


    //================================================================================
    // Collection Rules
    //================================================================================

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && hasValidUserData(userId);
      allow update: if isExistingOwner(userId) && isImmutableUserId();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages communities created by a user.
       * @path /users/{userId}/communities/{communityId}
       * @allow The user can manage their own communities.
       * @deny Other users cannot access or modify these communities.
       * @principle Enforces strict ownership via path hierarchy for user subcollections.
       */
      match /communities/{communityId} {
        allow read, delete: if isOwner(userId);
        allow create: if isOwner(userId) && hasValidCommunityData(userId);
        allow update: if isOwner(userId) && isImmutableCommunityOwnerId();
      }
    }

    /**
     * @description Manages publicly readable stories. Writes are currently disabled.
     * @path /stories/{storyId}
     * @allow Any user, signed in or not, reading a story: `(get)`.
     * @deny Any user trying to create a story: `(create)`. Denied because the schema lacks an ownership field.
     * @principle Implements a "Public Read with Owner-Only Writes" pattern. Writes are securely denied pending a schema update.
     */
    match /stories/{storyId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }
  }
}

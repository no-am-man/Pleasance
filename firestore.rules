
/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model for writes,
 * but allows for public readability of shared content like communities and profiles.
 * This supports discoverability while maintaining security.
 *
 * Data Structure:
 * - `/users/{userId}`: Strictly private user account data.
 *   - `/users/{userId}/stories/{storyId}`: Stories are nested and private to the user.
 *   - `/users/{userId}/assets/{assetId}`: Assets are nested and private to the user.
 * - `/community-profiles/{userId}`: Publicly readable profiles, writable only by the owner.
 * - `/communities/{communityId}`: Publicly readable communities, writable only by the owner.
 *   - `/communities/{communityId}/messages/{messageId}`: Messages are readable/writable by any signed-in user.
 *
 * Key Security Decisions:
 * - User data (`/users`) is strictly private.
 * - User-owned data (stories, assets) is nested under the user document, making it inherently private.
 * - Community Profiles (`/community-profiles`) are public to read, but a user can only write to their own profile.
 * - Communities (`/communities`) are public to read for discovery. Writes are restricted to the owner.
 * - Listing all users from the top-level `/users` collection is explicitly disallowed.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //================================================================================
    // Helper Functions
    //================================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingDoc() {
      return resource != null;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && isExistingDoc();
    }

    function isCommunityOwner(communityId) {
      return isSignedIn() && get(/databases/$(database)/documents/communities/$(communityId)).data.ownerId == request.auth.uid;
    }
    
    // --- User Validation Functions ---
    function hasValidUserData(userId) {
      return request.resource.data.id == userId;
    }

    function isImmutableUserId() {
      return request.resource.data.id == resource.data.id;
    }
    
    // --- Community Validation Functions ---
    function hasValidCommunityData() {
        return request.resource.data.ownerId == request.auth.uid;
    }
    
    function isImmutableCommunityOwnerId() {
        return request.resource.data.ownerId == resource.data.ownerId;
    }

    // --- Community Profile Validation ---
    function hasValidProfileData(userId) {
        return request.resource.data.userId == userId && request.resource.data.id == userId;
    }

    function isImmutableProfileIds() {
        return request.resource.data.id == resource.data.id && request.resource.data.userId == resource.data.userId;
    }

    // --- Subcollection Validation ---
    function hasValidSubcollectionData(userId) {
        // This validation is weak. It should check the incoming data.
        return request.resource.data.userId == userId || request.resource.data.ownerId == userId;
    }
    
    // --- Join Request Validation ---
    function isValidJoinRequest() {
        let incomingData = request.resource.data;
        return incomingData.userId == request.auth.uid
            && incomingData.status == 'pending';
    }

    function isValidMessageCreate() {
      let data = request.resource.data;
      return data.userId == request.auth.uid 
        && data.status == 'active'
        && data.keys().hasAll(['id', 'communityId', 'userId', 'userName', 'userAvatarUrl', 'audioUrl', 'transcription', 'createdAt', 'status']);
    }

    function isValidMessageUpdate() {
      let data = request.resource.data;
      // Allow only the 'status' field to be updated to 'done' or 'active'
      return data.status != resource.data.status
        && (data.status == 'done' || data.status == 'active')
        // Ensure other mutable fields are not changed during a status update
        && data.id == resource.data.id
        && data.userId == resource.data.userId
        && data.createdAt == resource.data.createdAt
        && data.userName == resource.data.userName
        && data.userAvatarUrl == resource.data.userAvatarUrl
        && data.audioUrl == resource.data.audioUrl
        && data.transcription == resource.data.transcription
        && data.communityId == resource.data.communityId;
    }
    

    //================================================================================
    // Collection Rules
    //================================================================================

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && hasValidUserData(userId);
      allow update: if isExistingOwner(userId) && isImmutableUserId();
      allow delete: if isExistingOwner(userId);

        /**
         * @description Manages AI-generated stories for a specific user.
         * @path /users/{userId}/stories/{storyId}
         * @allow A user can perform any action on their own stories.
         */
        match /stories/{storyId} {
            allow read, write: if isOwner(userId);
        }

        /**
         * @description Manages personal assets for a specific user.
         * @path /users/{userId}/assets/{assetId}
         * @allow A user can perform any action on their own assets.
         */
        match /assets/{assetId} {
            allow get, write: if isOwner(userId) && hasValidSubcollectionData(userId);
            allow list: if isOwner(userId);
        }
    }

     /**
     * @description Manages user community profiles.
     * @path /community-profiles/{userId}
     * @allow Anyone can read a profile, but only the owner can create/update/delete it.
     */
    match /community-profiles/{userId} {
        allow get: if true;
        allow list: if true;
        allow create: if isOwner(userId) && hasValidProfileData(userId);
        allow update: if isOwner(userId) && isImmutableProfileIds();
        allow delete: if isOwner(userId);
    }

    /**
     * @description Manages all communities.
     * @path /communities/{communityId}
     * @allow Anyone can read/list communities. Only the owner can create, update, or delete.
     */
    match /communities/{communityId} {
        allow get: if true;
        allow list: if true;
        allow create: if isSignedIn() && hasValidCommunityData();
        allow update: if isCommunityOwner(communityId) && isImmutableCommunityOwnerId();
        allow delete: if isCommunityOwner(communityId);

        /**
         * @description Manages voice messages within a community.
         * @path /communities/{communityId}/messages/{messageId}
         */
        match /messages/{messageId} {
            allow read: if true;
            allow create: if isSignedIn() && isValidMessageCreate();
            allow update: if (isOwner(resource.data.userId) || isCommunityOwner(communityId)) && isValidMessageUpdate();
            allow delete: if isCommunityOwner(communityId) || isOwner(resource.data.userId);


             /**
             * @description Manages voice comments on a specific message.
             * @path /communities/{communityId}/messages/{messageId}/comments/{commentId}
             * @allow Any signed-in user can read or write comments. Delete is restricted to owner or community owner.
             */
            match /comments/{commentId} {
                allow read: if true;
                allow create: if isSignedIn();
                allow update: if false;
                allow delete: if isSignedIn() && (isOwner(resource.data.userId) || isCommunityOwner(communityId));
            }
        }
        
        /**
         * @description Manages requests from users to join a community.
         * @path /communities/{communityId}/joinRequests/{requestId}
         */
        match /joinRequests/{requestId} {
            allow get: if isSignedIn() && (isCommunityOwner(communityId) || isOwner(resource.data.userId));
            allow list: if isCommunityOwner(communityId) || (isSignedIn() && request.query.where.userId == request.auth.uid);
            allow create: if isSignedIn() && isValidJoinRequest();
            allow update, delete: if isCommunityOwner(communityId);
        }
    }
  }
}
